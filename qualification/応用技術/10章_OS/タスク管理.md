## タスクとは
- コンピュータが実行中のプログラムであると識別する仕事の単位
- プロセスともいう

## タスクの状態遷移
- 実行可能状態(READY)
  - いつでも実行が可能な、CPUの使用権を待っている状態。
  - 生成直後のタスクはCPUの待ち行列に並ぶ
- 実行状態(RUN)
  - CPUの使用権を与えられて実行中の状態
- 待機状態(WAIT)
  - 入出力処理が発生したので、その終了を待っている状態

## ディスパッチャとタスクスケジューリング
- ディスパッチャ
  - 実行可能状態で順番待ちしているタスクに使用権を割り当てる
- タスクスケジューリング
  - 「どのタスクに使用権を割り当てるのか」を決めるためには実行準受を定める必要がある
    - 到着順方式
      - 実行可能状態になったタスク順にCPUの使用権を割り当てる方式
      - 実行途中にCPUの使用権が奪われることはない(ノンプリエンプション)
    - 優先度順方式
      - タスクに優先度を振り分け、優先度が高いものから実行していく方式。
      - 優先度の高いものが待ち行列に追加されると実行の途中でCPU使用権が奪われる(プリエンプション)
    - 動的優先順位方式
      - タスクがCPU使用権の割り当てを受けるまでの待ち時間の長さに応じて優先度を徐々に上げていく。
    - ラウンドロビン方式
      - CPUの使用権を一定時間ごとに霧香w流方式
      - 一定時間内に処理が終わらなかった場合は、次のタスクに使用権が与えられ、実行中だったタスクは待ち行列の最後に回される
    - 多重待ち行列方式
      - ラウンドロビンに優先順位を加味させた方式
    - 処理時間順方式
      - タスクの処理時間が短いものから順に処理する方式
    - イベントドリブン方式
      - マウスによる入力など、環境の変化でタスクを切り替える方式
  - コンテキスト切り替え
    - 実行中のタスクが別のタスクへとCPUの使用権を切り替えられること

- マルチプログラミング
  - タスク管理の役割は、CPUの有効活用によって最大化される。
  - CPUの遊休時間を最小限にとどめるのが大事。
    - 遊休時間とは、CPUが使われていない時間のこと
  - マルチプログラミングというのは、複数のプログラムを見かけ上同時に実行してみせることで遊休時間を減らし、CPUの利用効率を高める。

## タスクの排他/同期制御
### タスクの排他制御
- タスクは生成次にOSから独立した記憶領域を割り当てられる。
- しかし、どのタスクからもアクセスできるリソース(ファイルや共有メモリと言われる記憶領域)を用いる場合は、タスク同士で処理がぶつかる恐れがある。
- 排他制御について
  - 例えば、2つのタスクが存在し、領域の値を使用するものとする
  - タスク終了後に、領域の値を1つ足して終了する
  - 2つのタスクが同時に実行されると、「20」という値が入っている場合に、両タスクとも21で返却され、本来は22としないといけないのに値の齟齬が生じる
  - ロックをかけて占有するのが排他制御のかんがえ
- クリティカルセクション
  - 2つ以上のタスクが同時にリソースを奪い合うことで処理に不整合が生じる箇所。
- セマフォ
  - 排他制御を実行するために使用するもの。セマフォ変数に資源の共有状態を記録して、空いてなければ待つ。
  - S(セマフォ変数)
    - 初期値は1
  - P操作(資源ロック)
    - セマフォ変数が1以上の時、1減産してタスクの実行を継続する。
    - 0の時、実行を中断して、待ち行列に並ぶ
  - V操作(資源アンロック)
    - セマフォ変数に1加算する
    - 待ち行列の先頭タスクを実行可能状態に遷移させる。そのタスクは再度P操作ができる。
  - セマフォ変数の中身が任意個数であるものはゼネラルセマフォ
  - 0,1に限定されたものはバイナリセマフォという
- デッドロック
  - 排他制御において複数の資源をそれぞれのタスクが無秩序にロックされると相手のロックしている資源の解除待ちになり処理が止まること。
  - 対策法：資源のロック順序を両方のタスクで同じに揃えること

### 同期制御
- タスクは必ずしもそれ単独で動作するばかりではない。タスク同士が依存関係を持ち、一方の処理を待って他方が実行を再開するというった強調動作も行われる。
  - タスク同士を協調させるために実行タイミングを図る仕組み
- タスク間の同期方法として、基本的な手法が、イベントフラグ
- イベントフラグはカーネル監視下に置かれたビットの集合で、1つのビットが1つのイベントを表すフラグになっている。
- 順序
1. タスクAとタスクCは、イベントフラグ待ちであることをカーネルに伝える
2. タスクBがスイッチがONになったことを示すフラグをセット
3. 待機状態のAとCを実行可能状態に遷移させる。

## タスク間の通信
タスク同士が協調して動作をする際に、その間でデータをやり取りしながら処理を進める場合は、通信手段が必要。通信手段には下記がある
- 共有メモリ
  - メモリ上に複数のタスクから利用できる記憶領域を設けてデータ交換を行う
- メッセージキュー
- パイプ
  - 仮想的なパイプを通してやり取りする仕組み
